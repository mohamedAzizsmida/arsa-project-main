{% extends 'Admin-base.html.twig' %}


{% block body %}


        <link rel="stylesheet" href="{{ asset('css/adminproduit.css') }}" type="text/css">  
        
        <link rel="stylesheet" href="{{ asset('css/produit.css') }}" type="text/css">  
	<!-- ======== Preloader =========== -->
	<div id="preloader">
		<div class="spinner"></div>
	</div>
	<!-- ======== Preloader =========== -->

	<!-- ======== sidebar-nav start =========no== -->
	<aside class="sidebar-nav-wrapper">
		<div class="navbar-logo">
			<a href="{{ path('app_user_index') }}">
				<img src="{{ asset('img/ecodon.png') }}" alt="logo" style="width: 120px; height: auto; max-height: 60px; object-fit: contain;"/>
			</a>
		</div>
		<nav class="sidebar-nav">
			<ul>
				<span class="divider"><hr/></span>
				<li class="nav-item">
					<a href="{{ path('app_user_index') }}" class="nav-link">Gestion des Compte</a>
				</li>
				<li class="nav-item">
					<a href="{{ path('admin_tables') }}" class="nav-link">Evenenements</a>
				</li>

                <li class="nav-item">
                 <a href="{{ path('produit_admin') }}" class="nav-link">Produits</a>
                <ul class="list-unstyled ms-3">
                <li>
               <a href="{{ path('produit_admin') }}#statistiques" class="nav-link">Statistiques</a>

                </li>

                     <li><a href="{{ path('produit_admin') }}#commandes" class="nav-link">Commandes</a></li>
                 </ul>
               </li>
				{# <li class="nav-item">
					<a href="{{ path('app_blogs') }}" class="nav-link">
						<span class="icon">
							<svg width="20" height="20" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M1.66666 4.16667C1.66666 3.24619 2.41285 2.5 3.33332 2.5H16.6667C17.5872 2.5 18.3333 3.24619 18.3333 4.16667V9.16667C18.3333 10.0872 17.5872 10.8333 16.6667 10.8333H3.33332C2.41285 10.8333 1.66666 10.0872 1.66666 9.16667V4.16667Z"/>
								<path d="M1.875 13.75C1.875 13.4048 2.15483 13.125 2.5 13.125H17.5C17.8452 13.125 18.125 13.4048 18.125 13.75C18.125 14.0952 17.8452 14.375 17.5 14.375H2.5C2.15483 14.375 1.875 14.0952 1.875 13.75Z"/>
								<path d="M2.5 16.875C2.15483 16.875 1.875 17.1548 1.875 17.5C1.875 17.8452 2.15483 18.125 2.5 18.125H17.5C17.8452 18.125 18.125 17.8452 18.125 17.5C18.125 17.1548 17.8452 16.875 17.5 16.875H2.5Z"/>
							</svg>
						</span>
						<span class="text">Liste des blogs</span>
					</a>
				</li> #}
			</ul>
		</nav>
	</aside>
	<div class="overlay"></div>
	<!-- ======== sidebar-nav end =========== -->

	<!-- ======== main-wrapper start =========== -->
	<main
		class="main-wrapper">
		<!-- ========== header start ========== -->
		<header class="header">
			<div class="container-fluid">
				<div class="row">
					<div class="col-lg-5 col-md-5 col-6"></div>
					<div class="col-lg-7 col-md-7 col-6">
						<div
							class="header-right">
							<!-- profile start -->
							<div class="profile-box ml-15">
								<button class="dropdown-toggle bg-transparent border-0" type="button" id="profile" data-bs-toggle="dropdown" aria-expanded="false">
									<div class="profile-info">
										<div class="info">
											<div class="image">
												<img src="{{ asset('admin_assets/images/profile/profile-image.png') }}" alt=""/>
											</div>
											<div>
												<h6 class="fw-500">Adam Joe</h6>
												<p>Admin</p>
											</div>
										</div>
									</div>
								</button>
								<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profile">
									<li>
										<div class="author-info flex items-center !p-1">
											<div class="image">
												<img src="{{ asset('admin_assets/images/profile/profile-image.png') }}" alt="image">
											</div>
											<div class="content">
												<h4 class="text-sm">Adam Joe</h4>
												<a class="text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white text-xs" href="#">Email@gmail.com</a>
											</div>
										</div>
									</li>
									<li class="divider"></li>
									<li>
										<a href="#0">
											<i class="lni lni-user"></i>
											View Profile
										</a>
									</li>
									<li>
										<a href="#0">
											<i class="lni lni-alarm"></i>
											Notifications
										</a>
									</li>
									<li>
										<a href="#0">
											<i class="lni lni-inbox"></i>
											Messages
										</a>
									</li>
									<li>
										<a href="#0">
											<i class="lni lni-cog"></i>
											Settings
										</a>
									</li>
									<li class="divider"></li>
									<li>
										<a href="#0">
											<i class="lni lni-exit"></i>
											Sign Out
										</a>
									</li>
								</ul>
							</div>
							<!-- profile end -->
						</div>
					</div>
				</div>
			</div>
		</header>
		<!-- ========== header end ========== -->


		{# <nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">Admin Panel</a>
				<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
					<a href="{{ path('app_user_ajout') }}" class="text-white text-decoration-none">Add User</a>
				</button>

			</div>
		</nav> #}

        <div class="container-fluid stat" id="statistiques">
    <!-- ========== Statistiques Section ========== -->
    
        
           <div class="title-wrapper pt-30">
           <div class="row align-items-center">
            <div class="col-md-6">
                <div class="title">
                    <h2>Statistiques de vos Dons</h2>
                </div>
            </div>
        </div>
    </div>
     <div class="tables-wrapper">
        <div class="row col-md-12">
            <div class="col-md-3">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <span class="card-title">Total Quantités Produits</span>
                        <p class="card-text text-primary fs-4">{{ totalQuantities }}</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <span class="card-title">Total des produits donnés</span>
                        <p class="card-text text-primary fs-4">{{ totalProduitsDonnes }}</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <span class="card-title">Produits non distribués</span>
                        <p class="card-text text-danger fs-4">{{ produitsNonDistribues }}</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <span class="card-title">Produits totalement distribués</span>
                        <p class="card-text text-success fs-4">{{ totalProduitsDistribues }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row col-md-12 mt-3">
            <div class="col-md-6">
                <h2>Top 5 Produits les plus commandés</h2>
                <table class="table m-3">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Quantité commandée</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in topOrderedProducts %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.totalOrdered }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="col-md-6">
                <h2>Top 5 Produits les moins commandés</h2>
                <table class="table m-3">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Quantité commandée</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in topLeastOrderedProducts %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.totalOrdered }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

          {#  <div class="col-md-12">
                <h2 class="text-center">Variation de la Demande des Produits</h2>
                <canvas id="variationDemandesChart"></canvas>
            </div>#}
        </div>

        <div class="row col-md-12">
            <div class="col-md-6">
                <h2>Produits donnés par mois</h2>
                <canvas id="produitsParMoisChart"></canvas>
            </div>
            <div class="col-md-6">
                <h2>Répartition des dons par catégorie</h2>
                <canvas id="repartitionDonsChart"></canvas>
            </div>
        </div>

        <div class="row col-md-12">
            <h2 class="text-center mb-4">Quantité de Produits Donnés par Mois et Catégorie</h2>
            <div class="col-md-12">
                <canvas id="groupedBarChart"></canvas>
            </div>
        </div>
    </div>
    </div>

<div class="container-fluid" id="commandes">
    <!-- ========== title-wrapper start ========== -->
    <div class="title-wrapper pt-30">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="title">
                    <h2>Historique des Commandes</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== title-wrapper end ========== -->

    <!-- ========== table section start ========== -->
    <div class="tables-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <div class="card-style mb-30">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <!-- Search by ID -->
                        <div class="search-box">
                            <input type="text" class="form-control" id="searchInput" placeholder="Rechercher par ID commande...">
                            <i class="lni lni-search-alt"></i>
                        </div>

                        <!-- Search by Date -->
                        <div class="search-box">
                            <input type="date" class="form-control" id="searchDate">
                            <i class="lni lni-calendar"></i>
                        </div>
                    </div>

                    <h6 class="mb-10">Liste des Commandes</h6>

                    <!-- Table Content -->
                    <div class="table-wrapper table-responsive">
                   <table class="table" id="commandeTable">
    <thead>
     <tr>
    <th><h6>ID Commande</h6></th>
    <th><h6>Date de Commande</h6></th>
    <th><h6>Total Produits</h6></th>
    <th><h6>Status</h6></th> <!-- Add the Status Column -->
    <th><h6>Détails</h6></th>
</tr>
</thead>
<tbody>
    {% for commande in commandes %}
        <tr>
            <td>{{ commande.getIdCommande() }}</td>
            <td data-date="{{ commande.getDateCommande()|date('Y-m-d') }}">
                {{ commande.getDateCommande()|date('d/m/Y') }}
            </td>
            <td>
                {% set totalProducts = 0 %}
                {% for commandeProduit in commande.commandeProduits %}
                    {% set totalProducts = totalProducts + commandeProduit.quantite %}
                {% endfor %}
                {{ totalProducts }}
            </td>
            <td>
                <!-- Display the status as "En Attente" or "Valider" -->
                <span class="badge bg-{{ commande.getStatus() == 1 ? 'success' : 'warning' }}">
                  
                      {% if commande.status == 1 %}
                      Validée
                        {% else %}
                        En Attente
                             {% endif %}
                </span>
            </td>
            <td>
                <div style="display: ruby">
                    <!-- Button to open the modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderDetailsModal{{ commande.getIdCommande() }}">
                        Voir les détails
                    </button>
                                                  </ul>
  {% if commande.status != 1 %}
                                  <!-- Form to validate the command -->
                    <form action="{{ path('validate_order', {'id': commande.getIdCommande()}) }}" method="post">
                        <button type="submit" class="btn btn-success">Valider la commande</button>
                    </form>
{% endif %}
                </div>
            </td>
        </tr>
        <div class="modal fade orderdetails" id="orderDetailsModal{{ commande.getIdCommande() }}" tabindex="-1" aria-labelledby="orderDetailsModalLabel{{ commande.getIdCommande() }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel{{ commande.getIdCommande() }}">Détails de la Commande #{{ commande.getIdCommande() }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <!-- Display User Info -->
                            <div class="user-info mb-4">
                                <p><strong>ID Utilisateur:</strong> {{ commande.user.id }}</p>
                                <p><strong>Nom Utilisateur:</strong> {{ commande.user.nom }} </p>
                            </div>

                            <!-- Card to display product details -->
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Produits de la Commande</h5>
                                    <div class="list-group">
                                        {% for item in commande.commandeProduits %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <img src="{{ asset('uploadsImageProduit/' ~ item.produit.image) }}" alt="" width="50" class="me-3">
                                                    <div>
                                                        <h6 class="mb-0">{{ item.produit.nom }}</h6>
                                                        <small class="text-muted">Quantité: {{ item.quantite }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Section -->
                    <div class="row justify-content-end">
                        <div class="col-lg-6">
                            <div class="shoping__checkout">
                                <h5>Résumé de la commande</h5>
                                <ul>
                                    <li>Total <span>{{ commande.commandeProduits|length }} articles</span></li>
                                </ul>
  {% if commande.status != 1 %}
                                  <!-- Form to validate the command -->
                    <form action="{{ path('validate_order', {'id': commande.getIdCommande()}) }}" method="post">
                        <button type="submit" class="btn btn-success">Valider la commande</button>
                    </form>
{% endif %}
                             
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

        {% else %}
            <tr>
                <td colspan="4" class="text-center">Aucune commande trouvée.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
<!-- Flash messages will appear here -->
    {% for label, messages in app.flashes %}
        <div class="alert alert-{{ label == 'success' ? 'success' : (label == 'error' ? 'danger' : label) }} alert-dismissible fade show" role="alert">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
          
          </div>
    {% endfor %}

                    </div>                   
                </div>
            </div>
        </div>
    </div>
</div>
		<!-- ========== section end ========== -->
	</main>
	<!-- ======== main-wrapper end =========== -->
	<!-- ========= All Javascript files linkup ======== -->
	<script src="{{ asset('admin_assets/js/bootstrap.bundle.min.js') }}"></script>
	<script src="{{ asset('admin_assets/js/Chart.min.js') }}"></script>
	<script src="{{ asset('admin_assets/js/dynamic-pie-chart.js') }}"></script>
	<script src="{{ asset('admin_assets/js/moment.min.js') }}"></script>
	<script src="{{ asset('admin_assets/js/fullcalendar.js') }}"></script>
	<script src="{{ asset('admin_assets/js/jvectormap.min.js') }}"></script>
	<script src="{{ asset('admin_assets/js/world-merc.js') }}"></script>
	<script src="{{ asset('admin_assets/js/polyfill.js') }}"></script>
	<script src="{{ asset('admin_assets/js/main.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>// Fonction pour générer une couleur hexadécimale aléatoire
{#
function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
var ctxVariationDemandes = document.getElementById('variationDemandesChart').getContext('2d');

// Données pour le graphique de la variation des demandes
var variationDemandesData = {
    labels: {{ variationDemandes|map(row => row.mois)|json_encode|raw }},
    datasets: [
        {% for produit in topOrderedProducts %}
            {
                label: '{{ produit.name }}',
                data: [
                    {% for month in variationDemandes %}
                        {% if month.produit == produit.name %}
                            {{ month.quantite_restante  }},
                        {% endif %}
                    {% endfor %}
                ],
                borderColor: getRandomColor(), // Générer une couleur aléatoire pour chaque produit
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
                tension: 0.4
            },
        {% endfor %}
    ]
};

// Création du graphique avec Chart.js
new Chart(ctxVariationDemandes, {
    type: 'line',
    data: variationDemandesData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Mois'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Nombre de Commandes'
                },
                beginAtZero: true
            }
        }
    }
});
#}

    // Data for the line chart (Products Donated by Month)
 var produitsParMoisData = {
        labels: {{ produitsParMois|map(p => p.mois)|json_encode|raw }},
        datasets: [{
            label: 'Produits donnés par mois',
            data: {{ produitsParMois|map(p => p.count)|json_encode|raw }},
            borderColor: '#36a2eb',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            fill: true,
            tension: 0.4
        }]
    };

    var ctxMois = document.getElementById('produitsParMoisChart').getContext('2d');
    new Chart(ctxMois, {
        type: 'line',
        data: produitsParMoisData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.raw + " produits";
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mois',
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Nombre de produits donnés',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true
                }
            }
        }
    });

    // Data for the pie chart (Donations by Category)
    var donationsParCategorieData = {
        labels: {{ donationsByCategory|map(c => c.category)|json_encode|raw }},
        datasets: [{
            label: 'Répartition des dons par catégorie',
            data: {{ donationsByCategory|map(c => c.count)|json_encode|raw }},
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#FF9F40'],
            hoverOffset: 4
        }]
    };

    var ctxCategories = document.getElementById('repartitionDonsChart').getContext('2d');
    new Chart(ctxCategories, {
        type: 'pie',
        data: donationsParCategorieData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.raw + " produits";
                        }
                    }
                }
            }
        }
    });
    const ctx = document.getElementById('groupedBarChart').getContext('2d');
    const groupedBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ months|json_encode|raw }},
            datasets: {{ datasets|json_encode|raw }}
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' produits';
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mois'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Quantité de produits donnés'
                    },
                    beginAtZero: true
                }
            }
        }
    });

</script>
	<script>
    document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const searchDate = document.getElementById('searchDate');
    const rows = document.querySelectorAll("#commandeTable tbody tr");

    function filterTable() {
        let filterText = searchInput.value.toLowerCase();
        let filterDate = searchDate.value;
        console.log(filterDate);
        rows.forEach(row => {
            let idCommande = row.cells[0].textContent.toLowerCase();
            let dateCommande = row.cells[1].getAttribute('data-date'); // Get date in YYYY-MM-DD format

            let matchesText = idCommande.includes(filterText);
            let matchesDate = !filterDate || dateCommande === filterDate; // Show all if no date selected
            console.log(dateCommande);
            if (matchesText && matchesDate) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    searchInput.addEventListener('keyup', filterTable);
    searchDate.addEventListener('change', filterTable);
});
    </script>
{% endblock %}
